{% extends "base/base.html" %}

{% block customjs %}
    <script>
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container') || createToastContainer();
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'}"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastEl = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        {% if form.picture.value %}
        function rotateImage(direction) {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const imageUrl = "{{ form.picture.value.url }}";
            const button = event.target.closest('button');
            
            button.disabled = true;
            button.style.opacity = '0.6';

            fetch(`{% url "rotate_image" %}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify({direction, image_url: imageUrl}),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const img = document.getElementById("profile-picture");
                        img.src = data.new_image_url + '?t=' + Date.now();
                        showToast('Bild gedreht ✓', 'success');
                    } else {
                        showToast('Fehler beim Drehen des Bildes', 'danger');
                    }
                })
                .catch(() => showToast('Fehler beim Drehen des Bildes', 'danger'))
                .finally(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                });
        }
        {% endif %}
    </script>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
                <div class="card shadow-lg">
                    <!-- Header -->
                    <div class="card-header border-0 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h2 class="mb-0">
                            <i class="bi bi-person"></i> 
                            {% if action == "Update" %}
                                Bewohner bearbeiten
                            {% else %}
                                Neuen Bewohner hinzufügen
                            {% endif %}
                        </h2>
                    </div>

                    <!-- Form Body -->
                    <div class="card-body p-4">
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <!-- Profile Picture Section -->
                            <div class="mb-5">
                                <h5 class="mb-3">
                                    <i class="bi bi-image"></i> Profilbild
                                </h5>
                                <div class="row align-items-center g-4">
                                    {% if form.picture.value %}
                                        <div class="col-auto">
                                            <div class="position-relative" style="width: 150px; height: 150px;">
                                                <img src="{{ form.picture.value.url }}" alt="profil" id="profile-picture"
                                                     class="img-fluid rounded h-100 w-100" style="object-fit: cover;">
                                                <div class="position-absolute bottom-0 start-0 end-0 p-2 d-flex gap-2 justify-content-center"
                                                     style="background: rgba(0,0,0,0.5);">
                                                    <button type="button" class="btn btn-sm btn-light" onclick="rotateImage('left')">
                                                        <i class="bi bi-arrow-90deg-left"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-light" onclick="rotateImage('right')">
                                                        <i class="bi bi-arrow-90deg-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="col flex-grow-1">
                                        <div class="form-group">
                                            <label class="form-label">Neues Bild hochladen</label>
                                            {{ form.picture }}
                                            <small class="text-secondary d-block mt-2">
                                                <i class="bi bi-info-circle"></i> Unterstützte Formate: JPG, PNG, GIF
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Personal Information Section -->
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-person-lines-fill"></i> Persönliche Daten
                                </h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            {{ form.first_name }}
                                            <label for="{{ form.first_name.auto_id }}">Vorname</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            {{ form.last_name }}
                                            <label for="{{ form.last_name.auto_id }}">Nachname</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dates Section -->
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-calendar"></i> Zeiträume
                                </h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            {{ form.moved_in_since }}
                                            <label for="{{ form.moved_in_since.auto_id }}">Eingezogen am</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            {{ form.moved_out_since }}
                                            <label for="{{ form.moved_out_since.auto_id }}">Ausgezogen am</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Group Section -->
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-building"></i> Gruppe
                                </h5>
                                <div class="form-floating">
                                    {{ form.group }}
                                    <label for="{{ form.group.auto_id }}">Gruppe</label>
                                </div>
                                {% if form.group.value %}
                                    <div class="mt-2">
                                        <a href="{% url 'group' form.group.value %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-box-arrow-up-right"></i> Zur Gruppe
                                        </a>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Form Errors -->
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger" role="alert">
                                    <h5 class="alert-heading">Fehler im Formular</h5>
                                    {% for error in form.non_field_errors %}
                                        <p class="mb-0">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </form>
                    </div>

                    <!-- Footer -->
                    <div class="card-footer border-top bg-light">
                        <div class="d-flex gap-2">
                            <button type="submit" form="resident-form" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {{ action }}
                            </button>
                            <a href="{% url 'resident' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Abbrechen
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fix form submission -->
    <script>
        document.querySelector('form').id = 'resident-form';
        document.querySelector('button[type="submit"]').remove();
    </script>
{% endblock %}